<html lang="en">

<body>

    <h3 id="message">Please wait ...</h3>

    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.2.3/firebase-firestore.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <script>

        function setCookie(cname, cvalue, exdays) {
            var d = new Date();
            d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
            var expires = "expires=" + d.toGMTString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }

        function getCookie(cname) {
            var name = cname + "=";
            var decodedCookie = decodeURIComponent(document.cookie);
            var ca = decodedCookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        function getUrlVars() {
            var url = decodeURIComponent(window.location.href);
            var vars = [], hash;
            var hashes = url.slice(url.indexOf('?') + 1).split('&');
            for (var i = 0; i < hashes.length; i++) {
                hash = hashes[i].split('=');
                vars.push(hash[0]);
                vars[hash[0]] = hash[1];
            }
            return vars;
        }

        function sendCallBack(data) {
            $.post("http://localhost:4200/firebase-callback",
                JSON.parse(JSON.stringify(data)),
                function (data, status) {
                    console.log("data : " + JSON.stringify(data) + " status : " + status);
                });
        }

        (function () {
            // init firebase sdk
            firebase.initializeApp({
                apiKey: "AIzaSyCmNHYzjvDCbZdeO2IWJhYO55U6-3Hh-6M",
                authDomain: "famenun-2943.firebaseapp.com",
                databaseURL: "https://famenun-2943.firebaseio.com",
                projectId: "famenun-2943",
                storageBucket: "famenun-2943.appspot.com"
            });

            var action = getUrlVars()["action"];

            if (action == "login") {

                firebase
                    .auth()
                    .onAuthStateChanged(function (user) {
                        if (user) {

                            $("#message").text("Successfully logged in :)");

                            sendCallBack({
                                error: false,
                                message: "Successfully logged in :)",
                                action: action,
                                data: {
                                    uId: user.uid
                                }
                            });
                        } else {

                            $("#message").text("Logging in ...");

                            var method = getUrlVars()["method"];
                            if (method == "sessiontoken") {
                                var sessionToken = getUrlVars()["sessionToken"];
                                if (sessionToken != undefined && sessionToken != null) {
                                    $.post("https://us-central1-famenun-2943.cloudfunctions.net/apisClaimUserSessionToken",
                                        {
                                            sId: sessionToken,
                                            device: {
                                                id: "test",
                                                name: "desktop-vm",
                                                os: "windows",
                                                app: "chrome",
                                                time: Date.now()
                                            }
                                        },
                                        function (data, status) {
                                            if (status == "success") {
                                                if (!data.error) {

                                                    var customAuthToken = data.data;
                                                    firebase
                                                        .auth()
                                                        .signInWithCustomToken(customAuthToken)
                                                        .then(function (user) {

                                                            $("#message").text("Successfully logged in :)");

                                                            sendCallBack({
                                                                error: false,
                                                                message: "Successfully logged in :)",
                                                                action: action,
                                                                data: {
                                                                    uId: user.uid
                                                                }
                                                            });
                                                        })
                                                        .catch(function (error) {
                                                            sendCallBack({
                                                                error: true,
                                                                message: error
                                                            });
                                                        });
                                                } else {
                                                    sendCallBack({
                                                        error: true,
                                                        message: data.message
                                                    });
                                                }
                                            } else {
                                                sendCallBack({
                                                    error: true,
                                                    message: status
                                                });
                                            }
                                        });
                                } else {
                                    sendCallBack({
                                        error: true,
                                        message: "Invlid session token"
                                    });
                                }
                            }
                            // for qr

                        }
                    });

            } else if (action == "logout") {
                firebase
                    .auth()
                    .signOut()
                    .then(function () {

                        $("#message").text("Logged out successfully :)");

                        sendCallBack({
                            error: false,
                            message: "Logged out successfully :)",
                            action: action
                        });
                    })
                    .catch(function (error) {
                        sendCallBack({
                            error: true,
                            message: error
                        });
                    });
            } else if (action == "upload") {

                var file = getUrlVars()["file"];

                // upload file
                // get url
                // update version and url

                var user = getCookie("username");
                if (user != "") {
                    alert("Welcome again " + user);
                } else {
                    user = prompt("Please enter your name:", "");
                    if (user != "" && user != null) {
                        setCookie("username", user, 30);
                    }
                }

                firebase
                    .auth()
                    .onAuthStateChanged(function (user) {
                        if (user) {
                            var uid = user.uid;
                        } else {

                        }
                    });

            } else {

                $("#message").text("Unsupported action :(");

                sendCallBack({
                    error: true,
                    message: "Unsupported action"
                });
            }

        })();

    </script>
</body>

</html>